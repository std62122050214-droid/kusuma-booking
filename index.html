<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>🌻 ระบบจองห้องพัก - ไร่กุสุมา 2568</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
body { font-family: 'Sarabun', sans-serif; background: linear-gradient(135deg, #FEF3C7 0%, #FCD34D 50%, #F59E0B 100%); }
.room-card { cursor:pointer; transition: 0.3s; padding:20px; border-radius:12px; color:white; text-align:center; }
.room-card:hover { transform: translateY(-2px); box-shadow:0 10px 25px rgba(0,0,0,0.1);}
.available { background: #10B981; }
.partial { background: #F59E0B; }
.full { background: #EF4444; }
</style>
</head>
<body>

<div class="max-w-6xl mx-auto p-6">
    <h1 class="text-3xl font-bold mb-2 text-center">🌻 ระบบจองห้องพัก</h1>
    <p class="text-center mb-6">กิจกรรมท่องเที่ยวประจำปี 2568 ณ ไร่กุสุมา (จังหวัดสระบุรี) 11-12 ตุลาคม 2568</p>

    <h2 class="text-2xl font-bold text-center mb-4 text-pink-600">ห้องพักสำหรับผู้หญิง</h2>
    <div id="femaleRoomsContainer" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8"></div>

    <h2 class="text-2xl font-bold text-center mb-4 text-blue-600">ห้องพักสำหรับผู้ชาย</h2>
    <div id="maleRoomsContainer" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
</div>

<div id="bookingModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-xl max-w-md w-full">
        <h2 class="text-xl font-bold mb-4" id="modalRoomName"></h2>
        <form id="bookingForm" class="space-y-4">
            <div>
                <label class="block">รหัสพนักงาน</label>
                <input type="text" id="employeeId" class="w-full border px-3 py-2 rounded" required>
            </div>
            <div>
                <label class="block">ชื่อ-นามสกุล</label>
                <input type="text" id="fullName" class="w-full border px-3 py-2 rounded" required>
            </div>
            <div class="flex gap-3">
                <button type="button" onclick="closeModal()" class="flex-1 bg-gray-300 py-2 rounded">ยกเลิก</button>
                <button type="submit" class="flex-1 bg-yellow-500 text-white py-2 rounded">จอง</button>
            </div>
        </form>
    </div>
</div>

<div id="listModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-xl max-w-md w-full">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold" id="listRoomName"></h2>
            <button onclick="closeListModal()" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
        </div>
        <ul id="bookedList" class="space-y-2"></ul>
    </div>
</div>

<script>
// ✅ Firebase Config ที่แก้ไขแล้ว
const firebaseConfig = {
    apiKey: "AIzaSyAVMufRGEPh78rCyBGWeb5gNhgQEQhT1wI",
    authDomain: "room-25.firebaseapp.com",
    databaseURL: "https://room-25-default-rtdb.firebaseio.com",
    projectId: "room-25",
    storageBucket: "room-25.firebasestorage.app",
    messagingSenderId: "280652975807",
    appId: "1:280652975807:web:04f1110a952854a85d000a",
    measurementId: "G-GMGEHTP8GE"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const roomsData = [
    // ผู้หญิง
    {name:"บ้านเกาะใหญ่-หลัง1", capacity:2, gender:"female"},
    {name:"บ้านเกาะใหญ่-หลัง2", capacity:4, gender:"female"},
    {name:"บ้านเกาะใหญ่-หลัง3", capacity:3, gender:"female"},
    {name:"บ้านอิงแก่ง-หลัง1", capacity:3, gender:"female"},
    {name:"บ้านอิงแก่ง-หลัง2", capacity:3, gender:"female"},
    {name:"บ้านอิงแก่ง-หลัง3", capacity:3, gender:"female"},
    {name:"บ้านชมธาร-หลัง1", capacity:3, gender:"female"},
    {name:"บ้านชมธาร-หลัง2", capacity:3, gender:"female"},
    {name:"บ้านชมธาร-หลัง3", capacity:3, gender:"female"},
    {name:"บ้านชมแก่ง", capacity:3, gender:"female"},
    // ผู้ชาย
    {name:"บ้านเนินทราย", capacity:2, gender:"male"},
    {name:"A1", capacity:3, gender:"male"},
    {name:"A2", capacity:3, gender:"male"},
    {name:"A3", capacity:3, gender:"male"},
    {name:"A4", capacity:3, gender:"male"},
    {name:"A5", capacity:3, gender:"male"},
    {name:"A6", capacity:3, gender:"male"},
    {name:"A7", capacity:3, gender:"male"},
    {name:"B10", capacity:2, gender:"male"},
    {name:"B11", capacity:2, gender:"male"},
    {name:"B12", capacity:2, gender:"male"},
    {name:"B13", capacity:2, gender:"male"},
    {name:"B14", capacity:2, gender:"male"},
    {name:"บ้านเกาะเล็ก-หลัง1", capacity:3, gender:"male"},
    {name:"บ้านเกาะเล็ก-หลัง2", capacity:3, gender:"male"},
];

const femaleRoomsContainer = document.getElementById("femaleRoomsContainer");
const maleRoomsContainer = document.getElementById("maleRoomsContainer");
let selectedRoom = null;

function renderRooms(snapshot) {
    femaleRoomsContainer.innerHTML = "";
    maleRoomsContainer.innerHTML = "";
    const roomsBookedData = snapshot.val() || {};

    roomsData.forEach(room => {
        const booked = roomsBookedData[room.name] || [];
        const div = document.createElement("div");
        div.classList.add("room-card");
        div.dataset.name = room.name;

        if (booked.length === 0) div.classList.add("available");
        else if (booked.length < room.capacity) div.classList.add("partial");
        else div.classList.add("full");

        div.innerHTML = `<h3 class="font-bold">${room.name}</h3>
                         <p>${booked.length}/${room.capacity} คน</p>`;
        
        div.addEventListener("click", () => {
            // เมื่อคลิกที่ห้องที่มีคนจองแล้ว จะแสดงรายชื่อ
            if (booked.length > 0) {
                openListModal(room.name, booked);
            } else {
                openBookingModal(room.name, room.capacity);
            }
        });

        if (room.gender === "female") {
            femaleRoomsContainer.appendChild(div);
        } else {
            maleRoomsContainer.appendChild(div);
        }
    });
}

function openBookingModal(roomName, capacity) {
    selectedRoom = roomName;
    document.getElementById("modalRoomName").innerText = roomName;
    document.getElementById("bookingModal").classList.remove("hidden");
}

function openListModal(roomName, bookedList) {
    document.getElementById("listRoomName").innerText = `รายชื่อผู้จอง: ${roomName}`;
    const list = document.getElementById("bookedList");
    list.innerHTML = "";
    if (bookedList.length > 0) {
        bookedList.forEach(person => {
            const li = document.createElement("li");
            li.textContent = `รหัส: ${person.id}, ชื่อ: ${person.name}`;
            li.className = "p-2 bg-gray-100 rounded";
            list.appendChild(li);
        });
    } else {
        const li = document.createElement("li");
        li.textContent = "ยังไม่มีผู้จอง";
        li.className = "p-2 text-gray-500";
        list.appendChild(li);
    }
    document.getElementById("listModal").classList.remove("hidden");
}

function closeModal() {
    document.getElementById("bookingModal").classList.add("hidden");
    document.getElementById("bookingForm").reset();
}

function closeListModal() {
    document.getElementById("listModal").classList.add("hidden");
}

document.getElementById("bookingForm").addEventListener("submit", e => {
    e.preventDefault();
    const id = document.getElementById("employeeId").value;
    const name = document.getElementById("fullName").value;
    const roomRef = db.ref("rooms/" + selectedRoom);

    roomRef.once("value", snap => {
        const booked = snap.val() || [];
        
        const roomCapacity = roomsData.find(r => r.name === selectedRoom).capacity;

        if (booked.length >= roomCapacity) {
            alert("ห้องเต็มแล้ว!");
            closeModal();
            return;
        }
        
        const isAlreadyBooked = booked.some(person => person.id === id);
        if (isAlreadyBooked) {
            alert("รหัสพนักงานนี้ได้ทำการจองไปแล้ว!");
            closeModal();
            return;
        }

        booked.push({ id, name });
        roomRef.set(booked);
        closeModal();
    });
});

// Realtime update
db.ref("rooms").on("value", renderRooms);
</script>
</body>
</html>
